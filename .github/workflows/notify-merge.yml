name: Notify on Merge

on:
  pull_request:
    types: [closed]

permissions:
  actions: write
  contents: read

jobs:
  notify-merge:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - name: Send Bark Notification
        env:
          BARK_KEY: ${{ secrets.BARK_KEY || 'NsFjZ5nhRZNBhrHfcNBwES' }}
          TITLE: "PR Merged: ${{ github.event.pull_request.title }}"
          BODY: "Merged by ${{ github.actor }}. PR #${{ github.event.pull_request.number }}"
        run: |
          node -e '
            const https = require("https");
            const key = process.env.BARK_KEY;
            const title = encodeURIComponent(process.env.TITLE);
            const body = encodeURIComponent(process.env.BODY);
            const url = `https://api.day.app/${key}/${title}/${body}`;

            console.log("Sending notification...");
            https.get(url, (res) => {
              if (res.statusCode === 200) {
                console.log("Notification sent.");
              } else {
                console.error(`Failed with status: ${res.statusCode}`);
                process.exit(1);
              }
            }).on("error", (e) => {
              console.error(e);
              process.exit(1);
            });
          '

      - name: Trigger Deployment
        if: github.event.pull_request.merged == true
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          HAS_PAT: ${{ secrets.GH_PAT != '' }}
        run: |
          echo "Triggering deployment workflow..."
          if [ "$HAS_PAT" == "false" ]; then
            echo "::warning::Using GITHUB_TOKEN. Recursive workflows may not trigger. Please set GH_PAT secret for reliable auto-deployment."
          fi
          gh workflow run deploy.yml --ref main
